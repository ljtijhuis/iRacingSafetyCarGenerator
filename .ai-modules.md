# Module Reference Guide

Quick reference for module responsibilities, dependencies, and when to modify each component. For patterns, conventions, architecture overview, and gotchas, see `.ai-context.md`.

## Application Entry Point

### `src/main.py` (52 lines)
**Role:** Application entry point and initialization

**Key Functions:**
- `setup_logging()` - Configures logging from `logging.json`
- `parse_arguments()` - Handles command-line flags (-dev, -dwi, -dry)

**Dependencies:** App, logging configuration

**When to Modify:**
- Adding new command-line arguments
- Changing logging setup
- Modifying application initialization

---

## Core Application Modules

### `src/core/app.py` (1433 lines)
**Role:** Main Tkinter GUI application with state management

**Key Classes:**
- `App(tk.Tk)` - Main application window
- Manages 3-column layout: detectors, settings, controls
- Property-based state machine (`generator_state` property) — see `.ai-context.md` for pattern details

**Dependencies:**
- `Generator` - Core engine controlled by GUI
- `Settings` - Configuration management
- `Tooltip` - UI tooltip system

**When to Modify:**
- GUI layout changes
- Adding/modifying settings widgets
- State display updates
- Button behaviors

**Important Notes:**
- Runs in main thread (Tkinter mainloop)
- Polls `generator.state` for updates
- Never directly modifies Generator state

---

### `src/core/generator.py` (509 lines)
**Role:** Core engine orchestrating detection and safety car procedures

**Key Classes:**
- `Generator` - Main orchestrator (runs in separate thread)
- `GeneratorState(Enum)` - State machine enum

**Key Workflows:**
- `run()` - Main entry point (connects to iRacing, waits for green, starts loop)
- `_loop()` - Detection loop (~1 Hz)
- `_start_safety_car()` - Safety car procedure execution

**Dependencies:**
- `Detector` - Composite detector for all detection types
- `ThresholdChecker` - Event aggregation and threshold checking
- `CommandSender` - iRacing command execution
- `Drivers` - Driver state management
- `wave_arounds` - Wave around strategies

**When to Modify:**
- Main loop logic changes
- Safety car procedure modifications
- State transition logic
- Timing and eligibility windows

**Important Notes:**
- Thread-safe: no shared mutable state with main thread
- Updates own state via property setter
- Loop runs at ~1 Hz (1 second sleep + processing)

---

## Detection System

### `src/core/detection/detector.py` (84 lines)
**Role:** Composite detector coordinating all detection types

**Key Classes:**
- `Detector` - Composite pattern coordinator with builder via `build_detector()`. See `.ai-context.md` for builder and protocol patterns.
- `DetectorSettings` - Configuration dataclass including `accumulative_weights` dict — used by `build_detector()` to instantiate detectors that are individually disabled but have non-zero accumulative weight.

**Key Methods:** `build_detector()`, `detect()`, `race_started()`

**Dependencies:**
- `RandomDetector`, `StoppedDetector`, `OffTrackDetector`, `MeatballDetector` - Individual detectors
- `Drivers` - Driver state for detection
- `DetectorSettings` - Configuration for which detectors are enabled

**When to Modify:**
- Adding new detector types (see extension points in `.ai-context.md`)
- Changing detection coordination logic

---

### `src/core/detection/detector_common_types.py` (118 lines)
**Role:** Shared types, protocols, and enums for detection system

**Key Types:**
- `DetectorEventTypes(Enum)` - Event type identifiers (RANDOM, STOPPED, OFF_TRACK, MEATBALL)
- `SupportsDetect(Protocol)` - Interface for all detectors
- `DetectorState` - Current state passed to detectors (time, lap, counts)
- `DetectionResult` - Result from a detector
- `BundledDetectedEvents` - Collection of results from all detectors
- `DetectorSettings` - Configuration for all detectors (dataclass)
- `ThresholdCheckerSettings` - Threshold configuration (dataclass)

**When to Modify:**
- Adding new event types (extend `DetectorEventTypes` enum)
- Adding new detector settings (extend `DetectorSettings`)
- Adding new threshold settings (extend `ThresholdCheckerSettings`)

**Important Notes:**
- Protocol pattern enables loose coupling
- Dataclasses are frozen (immutable)
- Settings built via `from_settings()` factory method

---

### `src/core/detection/threshold_checker.py` (374 lines)
**Role:** Event aggregation with sliding time window and threshold checking

**Key Methods:** `register_detection_result()`, `clean_up_events()`, `threshold_met()`

**Key Settings Fields:**
- `ThresholdCheckerSettings` includes `individually_enabled_event_types` (set) — per-event-type threshold checks are skipped for detectors not in this set, so detectors running only for accumulative weight don't trigger individual thresholds.

See `.ai-context.md` for sliding window algorithm details and proximity clustering.

**Dependencies:**
- `ThresholdCheckerSettings` - Configuration
- `Driver` - Driver information for events

**When to Modify:**
- Threshold calculation logic
- Proximity clustering algorithm
- Dynamic threshold scaling
- Event expiration logic

---

### `src/core/detection/random_detector.py` (69 lines)
**Role:** Probabilistic safety car deployment

**Key Logic:**
- Converts overall race probability to per-second probability
- Time window constraints (start_minute to end_minute)
- Returns `DetectionResult` with `detected_flag` (not drivers)

**Dependencies:**
- `RandomDetectorSettings` - Configuration

**When to Modify:**
- Probability calculation logic
- Time window behavior

---

### `src/core/detection/stopped_detector.py` (82 lines)
**Role:** Detects stopped cars by comparing positions between frames

**Key Logic:**
- Compares `total_distance` between current/previous frames
- Filters out: pace car, cars in pits, negative lap_distance
- Lag protection: if too many cars stopped, likely SDK lag (see `.ai-context.md` gotchas)

**Dependencies:**
- `Drivers` - Current and previous driver states
- `StoppedDetectorSettings` - Configuration including lag threshold

**When to Modify:**
- Stopped car detection logic
- Pit/pace car filtering
- Lag detection threshold

---

### `src/core/detection/meatball_detector.py`
**Role:** Detects cars that just received the meatball (repairs required) flag via state-transition detection

**Key Logic:**
- Detects **transitions**: fires only when `session_flags & irsdk.Flags.repair` appears (was not set in previous frame, is set in current frame)
- Tracks `_last_non_pit_position[driver_idx]` for cars on-track or off-track, so that if a car tows to pit before receiving the flag, the event registers at the incident location
- Filters out pace car, cars with negative laps_completed, and NotInWorld cars
- Stateful: maintains position tracking across detect() calls
- Currently configured as shadow-only (threshold=99999, weight=0.0)

**Dependencies:**
- `Drivers` - Current and previous driver states

**When to Modify:**
- Adjusting meatball detection criteria
- Enabling for actual safety car triggering

---

### `src/core/detection/off_track_detector.py` (47 lines)
**Role:** Detects cars off track surface

**Key Logic:**
- Checks `track_loc == TrkLoc.off_track`
- Filters cars with negative laps_completed

**Dependencies:**
- `Drivers` - Current driver states
- `OffTrackDetectorSettings` - Configuration

**When to Modify:**
- Off-track detection criteria
- Additional filtering logic

---

## Data Management

### `src/core/drivers.py` (91 lines)
**Role:** Driver state management with double-buffering

**Key Classes:**
- `Driver(TypedDict)` - Driver data structure. See `.ai-context.md` for field definitions.
- `Drivers` - Manager with current/previous buffers (double-buffering pattern, see `.ai-context.md`)

**Dependencies:**
- `irsdk.IRSDK` - iRacing SDK for data

**When to Modify:**
- Adding new driver properties
- Changing data extraction from SDK
- Modifying filtering logic

---

### `src/core/settings.py` (250 lines)
**Role:** Type-safe wrapper around ConfigParser

**Pattern:** Typed property getters/setters wrapping `ConfigParser`:

```python
@property
def max_sc_events(self) -> int:
    return self.config.getint("General", "max_sc_events", fallback=5)

@max_sc_events.setter
def max_sc_events(self, value: int):
    self.config.set("General", "max_sc_events", str(value))
```

Always provide fallback defaults, use `getint`/`getfloat`/`getboolean`. Booleans stored as 0/1.

**File Location:** `src/settings.ini`

**When to Modify:**
- Adding new settings
- Changing default values
- Modifying setting categories

---

## Procedures

### `src/core/procedures/wave_arounds.py` (191 lines)
**Role:** Wave around strategy implementations

**Key Components:**
- `WaveAroundType(Enum)` - Strategy types (3 strategies, see `.ai-context.md` for details)
- `wave_arounds_factory()` - Returns appropriate strategy function
- `positions_from_safety_car()` - Calculate positions relative to pace car

**Dependencies:**
- `Drivers` - Driver positions and data

**When to Modify:**
- Adding new wave around strategies (see extension points in `.ai-context.md`)
- Modifying existing strategy logic
- Changing position calculation

---

### `src/core/procedures/class_split.py` (103 lines)
**Role:** Class splitting via EOL commands during safety car periods

**Key Functions:**
- `get_split_class_commands()` - Determines which cars need `!eol` commands to sort the grid by class speed

**Algorithm:**
1. Calculate positions relative to safety car
2. Group drivers by `CarClassID`, sort classes by `CarClassEstLapTime` (fastest first)
3. Walk the grid to find classes out of running order
4. Generate `!eol` commands for all drivers in out-of-order classes (cascading)

**Dependencies:**
- `generator_utils.positions_from_safety_car()` - Position calculation

**When to Modify:**
- Changing class splitting logic
- Adding support for more complex class ordering rules

---

## Interactions (Windows Automation)

### `src/core/interactions/command_sender.py` (60 lines)
**Role:** Send chat commands to iRacing via window automation

**Key Methods:** `send_command()`, `send_commands()`

**Command flow:** Open chat via `ir.chat_command(1)` → focus iRacing window via pywinauto → paste command via clipboard + Ctrl+V → send via Enter → wait 0.5s between commands. See `.ai-context.md` for timing gotchas.

**Dependencies:**
- `irsdk.IRSDK`, `IracingWindow`, `pyperclip`, `pywinauto.keyboard`

**When to Modify:**
- Command sending logic
- Timing/delays
- Error handling

---

### `src/core/interactions/interaction_factories.py` (22 lines)
**Role:** Factory for creating command senders

**Key Function:** `CommandSenderFactory()` — creates `CommandSender` or `MockSender` based on `-dwi` flag. See `.ai-context.md` for factory pattern.

**When to Modify:**
- Adding new interaction types
- Changing factory logic

---

### `src/core/interactions/mock_sender.py` (10 lines)
**Role:** Mock command sender for cross-platform development

**Key Behavior:**
- Logs commands instead of sending
- No Windows automation
- Enables development on macOS/Linux

**When to Modify:**
- Adding mock logging details
- Simulating command delays

---

### `src/core/interactions/iracing_window.py` (23 lines)
**Role:** Wrapper around pywinauto for iRacing window

**Dependencies:**
- `pywinauto.Application` (Windows-only, requires iRacing running)

**When to Modify:**
- Window detection logic
- Focus behavior

---

## Utility Modules

### `src/util/generator_utils.py` (48 lines)
**Role:** Utility functions for generator operations

**Key Functions:**
- `get_pace_car(ir)` - Find pace car index from SDK
- `get_current_lap(ir)` - Get current lap number from SDK

**When to Modify:**
- Adding new SDK helper functions
- Modifying data extraction logic

---

### `src/util/state_utils.py` (27 lines)
**Role:** State management utilities

**Key Functions:**
- Session state checking helpers

**When to Modify:**
- Adding state-related utilities

---

### `src/util/dev_utils.py`
**Role:** Development/debugging utilities

**Key Functions:**
- `copy_sdk_data_to_clipboard()` - Snapshot SDK data to clipboard (delegates to `sdk_dump.dump_sdk_snapshot()`)
- `send_test_commands()` - Test iRacing chat command rate limiting
- `parse_log_events_to_csv()` - Parse log files to CSV for analysis

**When to Modify:**
- Adding new development tools
- Adding debugging helpers

---

### `src/util/sdk_dump.py`
**Role:** SDK data capture and continuous recording

**Key Functions:**
- `dump_sdk_snapshot(ir)` - Capture all telemetry variables and session info from a connected SDK instance
- `save_snapshot(ir)` - Save a snapshot as a JSON file in `dumps/`
- `SdkRecorder` class - Background thread that records snapshots every second to an NDJSON file

**Dependencies:**
- `irsdk.IRSDK` - Connected SDK instance

**When to Modify:**
- Changing which SDK variables are captured
- Modifying recording interval or output format

---

## Testing Utilities

### `src/core/tests/test_utils.py` (94 lines)
**Role:** Common test fixtures and utilities

**Key Functions:** `make_driver()`, `dict_to_config()` — see `.ai-context.md` for usage examples.

**When to Modify:**
- Adding new test fixtures
- Adding test data builders

---

## UI Support

### `src/core/tooltip.py` (48 lines)
**Role:** Tooltip functionality for GUI

**Key Classes:**
- `Tooltip` - Hover tooltip implementation

**Dependencies:**
- `tooltips_text.json` - Tooltip text content

**When to Modify:**
- Changing tooltip behavior
- Modifying tooltip styling

---

## Configuration Files

### `src/settings.ini`
**Role:** User settings persistence

**Sections:**
- `[General]` - Overall settings (max events, timing)
- `[RandomDetector]` - Random SC settings
- `[StoppedDetector]` - Stopped car settings
- `[OffTrackDetector]` - Off-track settings
- `[ThresholdChecker]` - Threshold and weighting settings
- `[WaveArounds]` - Wave around strategy and timing

---

### `src/logging.json`
**Role:** Logging configuration

**Controls:**
- Log level (DEBUG, INFO, WARNING, ERROR)
- File output location (`logs/`)
- Log format

---

### `src/tooltips_text.json`
**Role:** Tooltip text content

**When to Modify:**
- Adding new tooltips
- Updating help text

---

## Build and Deployment

### `build.py` (21 lines)
**Role:** Build script for creating executable

**Key Functionality:**
- Uses PyInstaller to create standalone executable
- Bundles dependencies and assets

**When to Modify:**
- Adding new assets to bundle
- Changing build configuration
- Modifying icon or version info

---

## Module Dependency Graph

```
main.py
    └── App (core/app.py)
        └── Generator (core/generator.py)
            ├── Detector (detection/detector.py)
            │   ├── RandomDetector
            │   ├── StoppedDetector
            │   ├── OffTrackDetector
            │   └── MeatballDetector
            ├── ThresholdChecker (detection/threshold_checker.py)
            ├── CommandSender (interactions/command_sender.py)
            │   ├── IracingWindow (interactions/iracing_window.py) [Windows]
            │   └── MockSender (interactions/mock_sender.py) [Dev]
            ├── Drivers (core/drivers.py)
            ├── wave_arounds (procedures/wave_arounds.py)
            └── class_split (procedures/class_split.py)
```

---

## Quick Navigation Guide

**Need to change detection logic?** → `src/core/detection/`
**Need to change GUI?** → `src/core/app.py`
**Need to change safety car procedure?** → `src/core/generator.py` (_start_safety_car, _send_wave_arounds)
**Need to change wave around rules?** → `src/core/procedures/wave_arounds.py`
**Need to change thresholds?** → `src/core/detection/threshold_checker.py`
**Need to add settings?** → `src/core/settings.py` + `src/settings.ini`
**Need to change Windows automation?** → `src/core/interactions/`
**Need to add tests?** → `src/*/tests/` (co-located with source)

---

## See Also

- `.ai-context.md` - Patterns, conventions, testing requirements, post-implementation checklist, and gotchas
- `ARCHITECTURE.md` - System design and workflows
- `CONTRIBUTING.md` - Development environment setup, commit conventions, and PR process
- `docs/RACING_CONCEPTS.md` - Racing domain knowledge
